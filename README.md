# DFR Browser 2

A modern, responsive topic modelling browser built with Bootstrap 5, D3.js, and page.js routing. This application provides interactive visualizations and analysis tools for exploring topic models generated by MALLET.

DFR Browser 2 is based on Andrew Goldstone's [dfr-browser](https://github.com/agoldst/dfr-browser). It reproduces all the major functionality of the original, but with an entirely new architecture and additional features.

## Table of Contents

- [Features](#features)
- [Getting Started](#getting-started)
- [File Requirements](#file-requirements)
- [Configuration](#configuration)
- [Application Views](#application-views)
- [Permalink Support](#permalink-support)
- [Localization](#localization)
- [Browser Requirements](#browser-requirements)
- [Development](#development)

## Features

### ✅ Core Functionality

- **Modern Routing**: Clean page.js routing with permalink support for all views
- **Responsive Design**: Bootstrap 5-based responsive layout
- **Interactive Visualizations**: D3.js-powered charts and graphs
- **Multilingual Support**: Built-in support for 10 languages with customizable alphabets
- **Bibliography Management**: CSL-based citations with IndexedDB caching
- **State File Integration**: Enhanced word extraction from MALLET state files
- **Auto-Reload Settings**: Settings changes take effect immediately

### Views Implemented

- ✅ **Overview** - Grid, Scaled, List, and Stacked topic visualizations
- ✅ **Topic View** - Detailed topic analysis with word distributions and top documents
- ✅ **Document View** - Individual document analysis with topic composition
- ✅ **Word View** - Word analysis across topics with interactive visualizations
- ✅ **Bibliography** - Sortable citation list with custom sorting and IndexedDB caching
- ✅ **Word Index** - Alphabetical word index with basic/complete vocabulary modes
- ✅ **About** - Customizable information page with Markdown support
- ✅ **Settings** - User preferences for display options and cache management

## Getting Started

### Prerequisites

- Python 3.x for data preparation. A local server may be started either by Python or Node.js. Other server-architectures will be supported in the future.
- Modern web browser (Chrome, Firefox, Safari, Edge)
- MALLET topic model output files and relevant metadata files

### Running the Application

Navigate to the `dist` directory.

If you have Python installed, you may start a local web server with

  ```bash
  python3 server.py
  ```

The default port is 8000. If you wish to change it, just add your chosen port at the end:

  ```bash
  python3 server.py 5000
  ```

If you have Node.js installed, the easiest method is to install the `serve` package globally with `npm install -g serve`. Then run:

  ```bash
  serve -l 8000 --single # Or change 8000 to your custom port number
  ```

Next open your browser and navigate to `http://localhost:8000` (or whatever port you have chosen).

**Notes:**

1. Dfr Browser 2 requires Single Page Application (SPA) routing behaviour, and the methods above ensure that this is implemented. If you wish to serve or host the application by some other means, you may have to play with your server configuration. Support for more serving/hosting methods is planned for the future.
2. Although your app will be served on a localhost, internet access is still recommended because the app currently downloads Google fonts. Without internet access, the fallback font may negatively impact the display.

## File Requirements

It is recommended that you deposit all data and metadata files that will be accessed by the app in the `data` folder for easy location. However, you may point to other locations or or upload the files from within the app, depending on your configuration. This will be discussed below.

### Required Files

#### 1. Topic Keys File (`topic-keys.txt`)

Generated by MALLET `--output-topic-keys`

Contains the top k words for each topic and Dirichlet parameters.

**Format:**

```txt
0 0.5 word1 word2 word3 word4 word5
1 0.3 word6 word7 word8 word9 word10
```

#### 2. Document-Topic File (`doc-topics.txt`)

Generated by MALLET `--output-doc-topics`

Contains topic composition for each document.

**Format:**

```txt
#doc name topic proportion ...
0 doc1.txt 0 0.8 1 0.2
1 doc2.txt 0 0.3 1 0.7
```

#### 3. Metadata File (`metadata.csv`)

User-generated CSV file with document metadata.

**Required Fields:**

- `docNum` - Document number (0-based index)
- `docName` - Document identifier
- `title` - Document title
- `year` - Publication year

You may have an arbitrary number of additional fields. If you have fields that match [CSL-JSON](https://citeproc-js.readthedocs.io/en/latest/csl-json/markup.html) properties, you will be able to use the metadata to generate well-formatted bibliographies using the `bin/metadata_to_csl.py` script.

**Example:**

```csv
docNum,docName,title,author,year,journal
0,doc1,Example Title,Smith J.,2020,Journal Name
1,doc2,Another Title,Jones M.,2021,Different Journal
```

#### 4. Topic State File (`topic-state.gz`)

Generated by MALLET `--output-state`

**Important:** Must be generated with a recent version of MALLET that outputs the new format.

A compressed text file containing word-topic assignments for the entire corpus. This file is used to:

- Extract enhanced word lists for topics
- Generate complete vocabulary for the Word Index
- Calculate document lengths and token counts

### Optional Files

#### 1. Topic Coordinates (`topic_coords.csv`)

User-generated file for custom topic positioning in the Scaled view.

**Format:**

```csv
topic,x,y
0,0.5,0.3
1,0.2,0.8
```

The `topic_coords.csv` file may be generated from the MALLET state file using the `bin/prepare_dfr_data.py` script.

#### 2. Bibliography File (`bibliography.json`)

[CSL-JSON](https://citeproc-js.readthedocs.io/en/latest/csl-json/markup.html) formatted bibliography for enhanced citations.

If provided, this file is used instead of generating citations from the `metadata.csv` file. If not provided, the browser will produce an approximation of Chicago Author-Date style using information available in the `metadata.csv` file.

**Important:**

- The `bibliography.json` file should be generated using the `bin/metadata_to_csl.py` script, which adds a `formatted_citation` field that contains a string representation of each entry. This is used to display the entries within the app. The individual citation fields are only used for sorting purposes.
- The `bibliography.json` file cannot currently be uploaded via the UI; the path must be specified in `config.json`. See the discussion of Configuration below.

#### 3. Source Text File

Tab-separated text file with document content (optional).

**Format:**

```txt
doc_id label text_content
```

or

```txt
doc_id text_content
```

## Configuration

All configuration is managed through the `config.json` file in the root directory.

### Application Settings

The application settings should be left alone, as they identify the version of the application you are using.

```json
{
  "application": {
    "name": "DFR Browser 2",
    "version": "2.0.0"
  }
}
```

### Brand Customization

You can customize the navbar brand, including the title, logo, and favicon:

```json
{
  "brand": {
    "name": "My Research Project",
    "url": "https://myuniversity.edu/project",
    "logo": "images/logo.png",
    "favicon": "/path/to/your/custom-favicon.png"
  }
}
```

- **name**: Text displayed in navbar
- **url**: Link target (use "#" for no link)
- **logo**: Path to logo image (null for text-only)

External URLs open in a new tab. The page title automatically updates to match the brand name.

### Data File Paths

```json
{
  "data_source": "data/docs.txt",
  "topic_keys_file": "data/topic-keys.txt",
  "doc_topic_file": "data/doc-topic.txt",
  "metadata_file": "data/metadata.csv",
  "topic_state_file": "data/topic-state.gz",
  "topic_coords_file": "data/topic_coords.csv"
}
```

All paths are relative to the application root. If you wish to provide users with access to the original documents, use the `data_source` field. It should point to a text file in the format described under Source Text File above. If the `embargo` field is set to `true`, the `data_source` will be ignored.

### File Upload

```json
{
  "show_upload_form": false
}
```

Set to `true` to enable the manual file upload form when the application is loaded. If `true`, the app will not look for the data file paths (except `data_source`, if present) and will instead use the files the user uploads using the upload form.

### Bibliography Configuration

Providing a bibliography allows the app to provide well-formatted bibliographical citations in many styles.

```json
{
  "bibliography": {
    "path": "data/bibliography.json",
    "style": "chicago",
    "locale": "en-US"
  }
}
```

- **path**: Path to CSL-JSON file
- **style**: Citation style (chicago, apa, mla, etc.)
- **locale**: Locale for formatting

**Note:** The `style` and `locale` are largely for informational purposes. The app itself displays entries using the content of the `formatted_citation` field in the `bibliography.json` file. Sorting is based on the Language Settings.

### Language Settings

The application supports 10 languages out of the box:

```json
{
  "language": {
    "default": "en",
    "configs": {
      "en": {
        "name": "English",
        "alphabet": ["A", "B", "C", "D", "E", "F", "G", "H", "I", "J", "K", "L", "M", "N", "O", "P", "Q", "R", "S", "T", "U", "V", "W", "X", "Y", "Z"],
        "locale": "en-GB"
      }
    }
  }
}
```

**Supported Languages:**

- English (en)
- Spanish (es) - includes Ñ
- French (fr)
- German (de) - includes Ä, Ö, Ü, ß
- Italian (it)
- Portuguese (pt) - includes accented characters
- Russian (ru) - Cyrillic alphabet
- Chinese (zh) - radical-based grouping
- Japanese (ja) - hiragana alphabet
- Arabic (ar) - right-to-left support

Each language configuration includes:

- **name**: Display name
- **alphabet**: Array of characters for word grouping (used for displaying alphabetic navigation links)
- **locale**: Locale code for sorting
- **rtl**: Right-to-left flag (Arabic only)
- **useRadicals**: Radical grouping flag (Chinese only)

### Default Settings

User-configurable defaults:

```json
{
  "settings": {
    "defaults": {
      "showHiddenTopics": false,
      "wordsInLists": 15,
      "wordsInTopic": 50,
      "wordsInCircles": 6,
      "topicDocs": 20
    }
  }
}
```

Users can override these via the Settings modal in the app. Changes are saved to localStorage and take effect immediately.

- **showHiddenTopics**: Forces any topics hidden elsewhere the configuration to be displayed (see Topic Customization below)
- **wordsInLists**: The number of words to display (in order of prominence) whenever there is a list of words
- **wordsInTopic**: The number of words to display (in order of prominence) to be displayed in the Top Word Distribution card of Topic pages
- **wordsInCircles**: The number of words to display (in order of prominence) in the Overview Grid and Scaled displays
- **topicDocs**: The number of documents (in order of prominence) to be displayed in the Top Documents card of Topic pages

### Topic Customization

Customize topic display and metadata field mappings:

```json
{
  "topics": {
    "labels": {
      "0": "Education & Schools",
      "5": "Economic Policy"
    },
    "hidden": [3, 7, 15]
  },
}
```

- **topics.labels**: Override default topic numbering with custom labels
- **topics.hidden**: Hide specific topics from all views (can be toggled in Settings)

**Note**:

Hiding topics may remove low-quality or incoherent topics, or topics that are artifacts of the modeling process, from view. This may help focus focus analysis on topics of interest. But it can also be deceptive, so this feature should be used with care.

### Metadata Field Mappings

Map non-standard metadata field names to the internal names expected by the application.

```json
{
  "metadata": {
    "fieldMappings": {
      "title": "article_title",
      "author": "creator",
      "year": "publication_year",
      "journal": "venue"
    }
  }
}
```

**How it works:**

- The application internally uses standard field names: `title`, `author`, `year`, `journal`, etc.
- If your metadata CSV uses different column names, map them here
- The application will automatically use the mapped names when accessing metadata

**Required fields** (must be mapped if using different names):

- `docNum` - Document number (0-based index)
- `docName` - Document identifier
- `title` - Document title
- `year` - Publication year

**Example scenario:**

Your metadata CSV has these columns:

```csv
doc_index,doc_id,article_title,creator,pub_year,venue
0,doc1,Example Article,Smith J.,2020,Journal of Examples
```

Configure the mapping:

```json
{
  "metadata": {
    "fieldMappings": {
      "docNum": "doc_index",
      "docName": "doc_id",
      "title": "article_title",
      "author": "creator",
      "year": "pub_year",
      "journal": "venue"
    }
  }
}
```

Now the application will correctly access your metadata using the custom field names.

### About Page Content

The default About page content can be replaced by any content formatted in Markdown. The Markdown is converted to HTML using [markdown-it](https://github.com/markdown-it/markdown-it). Since the text must be represented on a single line in JSON, you should use `\n` to indicate line breaks.

## Application Views

### Overview

Four visualization modes for exploring all topics:

- **Grid**: Topics arranged in a grid, sized by frequency
- **Scaled**: 2D topic map using coordinates from `topic_coords.csv`
- **List**: Table view with topic words and statistics
- **Stacked**: Area chart showing topic proportions over time

### Topic View

Detailed analysis of individual topics:

- Topic word distribution with weights
- Top documents containing the topic
- Topic proportion over time
- Year-based filtering
- Word links to Word View

**Access:** `http://localhost:8000/topic/{number}` (1-based)

**Example:** `http://localhost:8000/topic/5` for Topic 5

### Document View

Individual document analysis:

- Document metadata
- Topic composition visualization
- Top words in document
- Links to related topics

**Access:** `http://localhost:8000/document/{index}` (0-based)

**Example:** `http://localhost:8000/document/123` for document 123

### Word View

Word analysis across topics:

- Search bar for any word
- Topics where word is prominent
- Interactive visualization showing word context
- Top words in each related topic
- Click words or topics to navigate

**Access:** `http://localhost:8000/word` or `http://localhost:8000/word/{word}`

**Example:** `http://localhost:8000/word/education`

### Bibliography

Sortable citation list with advanced features:

- Chicago Author-Date style citations by default
- Sort by author, year, title, or journal
- Advanced custom sorting (up to 3 fields)
- Alphabet and year navigation
- View Document buttons
- IndexedDB caching (24-hour expiry)
- Cache management tools

**Access:** `http://localhost:8000/bibliography`

### Word Index

Alphabetical word listing:

- Two modes: Basic (topic words only) and Complete (full vocabulary from state file)
- Language-aware alphabetical grouping
- Sticky alphabet navigation
- Click any word to view Word analysis

**Access:** `http://localhost:8000/wordlist`

### Settings

Modal dialog for user preferences:

- Words shown in lists (Overview/dropdown)
- Words shown in Topic/Word views
- Words in Overview circles
- Top documents in Topic view
- Show hidden topics (if topics are hidden in the configuration)

Settings are saved to localStorage and take effect immediately upon saving.

**Access:** Click "Settings" in navigation

## Permalink Support

All views support direct URL access for bookmarking and sharing:

### Topic Permalinks

```url
http://localhost:8000/topic/5
```

Topics use 1-based numbering (Topic 1, Topic 2, etc.)

### Document Permalinks

```url
http://localhost:8000/document/123
```

Documents use 0-based indexing matching the metadata.csv docNum field

### Word Permalinks

```url
http://localhost:8000/word/government
```

URLs are automatically encoded to handle special characters

## Localization

The application includes localization support for sorting. Localization for application labels may be implemented in the future.

### Changing the Default Language

Edit `config.json`:

```json
{
  "language": {
    "default": "es"
  }
}
```

### Adding New Languages

Add a new language configuration:

```json
{
  "language": {
    "configs": {
      "he": {
        "name": "עברית",
        "alphabet": ["א", "ב", "ג", "ד", "ה", "ו", "ז", "ח", "ט", "י", "כ", "ל", "מ", "נ", "ס", "ע", "פ", "צ", "ק", "ר", "ש", "ת"],
        "locale": "he-IL",
        "rtl": true
      }
    }
  }
}
```

### Language Features

- **Alphabet Navigation**: Word Index uses custom alphabets
- **Locale-Aware Sorting**: All text sorting respects locale
- **RTL Support**: Right-to-left languages fully supported
- **Diacritic Handling**: Automatic normalization for Latin scripts

## Browser Requirements

### Minimum Requirements

- Modern browser with ES6+ support
- JavaScript enabled
- localStorage support
- IndexedDB support (for bibliography caching)

### Recommended Browsers

- Chrome 90+
- Firefox 88+
- Safari 14+
- Edge 90+

Currently tested only on Chrome and Firefox.

### Known Issues

- The application must be served using the built-in `serve.py` in order for the routing to work correctly. Support for serving the app by other means and for hosting the app on a public server will be added soon.
- Large datasets can take a long time to load. Once they are loaded and cached, page loading is fast.
- The Python data preparation scripts in the `bin` directory are not yet ready for primetime (as of v0.2.3). Use with caution.

## Development

### App Structure

```bash
dist/
├── index.html             # Main HTML file
├── config.json            # Application configuration
├── server.py              # Python development server with SPA routing
├── assets/
│   └── favicon-16x16.png  # Application favicon
├── css/
│   ├── bootstrap.min.css          # Bootstrap 5 framework
│   ├── bootstrap-icons.css        # Bootstrap Icons
│   ├── custom-sort-modal.css      # Custom sorting modal styles
│   ├── style.css                  # Main custom styles
│   └── fonts/                     # Icon fonts
├── js/
│   ├── main.js                    # Application entry point with routing
│   ├── about.js                   # About page with markdown-it rendering
│   ├── overview.js                # Overview view (Grid, Scaled, List, Stacked)
│   ├── topic.js                   # Topic detail view
│   ├── document.js                # Document detail view
│   ├── word.js                    # Word analysis view
│   ├── wordlist.js                # Word index view
│   ├── bibliography.js            # Bibliography with caching and sorting
│   ├── state-utils.js             # MALLET state file parsing utilities
│   ├── topic-config.js            # Topic customization (labels, hiding, mapping)
│   ├── cache-manager.js           # IndexedDB cache management
│   ├── cached-data-loader.js      # Data loading with caching
│   ├── data-validator.js          # Data validation utilities
│   ├── error-handler.js           # Error handling and display
│   ├── bootstrap.bundle.min.js    # Bootstrap JavaScript
│   ├── d3.min.js                  # D3.js visualization library
│   ├── index.js                   # Page.js routing library
│   └── markdown-it.min.js         # Markdown parser for About page
├── bin/
│   ├── prepare_dfr_data.py        # Data preparation script
│   └── metadata_to_csl.py         # Metadata to CSL conversion
└── data/                          # The files below would be added by the user
    ├── topic-keys.txt             # MALLET topic-keys output
    ├── doc-topics.txt             # MALLET doc-topics output
    ├── doc-topic-counts.csv       # Document-topic count matrix
    ├── metadata.csv               # Document metadata
    ├── topic-state.gz             # MALLET topic state
    ├── topic_coords.csv           # Topic coordinates for scaled view
    └── bibliography.json          # CSL-formatted citations
```

### Dependencies

- **Bootstrap 5.3**: UI framework
- **D3.js v7**: Data visualizations
- **page.js**: Client-side routing
- **markdown-it**: Markdown rendering for About page

### Key Architectural Decisions

1. **page.js Routing**: Clean URLs without hash fragments
2. **Absolute Paths**: All asset and data paths use `/` prefix for permalink support
3. **Auto-loading**: Data loads automatically when accessing routes directly
4. **State Management**: Global `window.dfrState` object for shared data
5. **IndexedDB Caching**: Bibliography caching with 24-hour expiry
6. **Settings Persistence**: localStorage for user preferences

### Adding New Features

Page routing is very fragile, so new features have to be added with caution. But it should be possible to add additional pages that access cached data easily enough.

### Debugging

All routes and data loading operations are logged in the browser console with the prefix "[DFR]".

### Testing

Currently the `tests` folder only includes tests for cache management and citation conversion. To run the test, copy the folder into your app's root, start the app and navigate to `tests/test_cache.html` or `tests/test_citation.html`.

### Roadmap

1. Model Diagnostics visualisation in Overview.

## Differences from Original DFR Browser

The [original dfr-browser](https://github.com/agoldst/dfr-browser) has been re-built from the ground up using the latest Bootstrap and D3 libraries, as well as a third-party routing system. Most MALLET data is loaded from the MALLET state file and converted in the app, which may lead to a performance hit, especially when the app is first loaded. Once the data is loaded, it is cached, so it the app should be fast thereafter.

The app is freed from its expectation of journal article data, and the user is now able to more easily generate references in a wide range of bibliographical styles. The user can also designate a location for their original documents and display them directly within the app. The configuration file also enables language customization to support multilingual sorting rules.

New styling provides a fresh look and easier customization potential. In some cases, especially for bibliography, this provides enhanced navigation features.

## Credits

Based on [dfr-browser](https://github.com/agoldst/dfr-browser) by Andrew Goldstone.

This project began as a test case for using <a href="https://github.com/github/spec-kit" target="_blank">GitHub Spec-Kit</a>. Most of the code and document generation was done in collaboratio with Claude Sonnet 4 or Claude Sonnet 4.5.

## Licence

The app is distributed under the MIT Licence.

## Support

Use the GitHub Issues to open a ticket.

## Changelog

### Version 0.2.3

- First public release on GitHub.

### Version 0.2.2

- Many small styling bugs fixed.
- Caching functions tested.
- Refactored project for pushing to GitHub.
- Development of a distribution folder.
- Fix to word links in Topic view.
- Provide full Markdown conversion for the About page.

### Version 0.2.1

- Add data validation and error handling
- Add advanced customisation options: user-defined topic labels/names, hide/rename specific topics, custom metadata field mappings.
- Add full ARIA labels for screen readers.

### Version 0.2.0

- Complete refactor with page.js routing
- Permalink support for all views
- Enhanced bibliography with IndexedDB caching
- Multilingual support (10 languages)
- Auto-reload settings
- Bootstrap 5 UI
- State file integration for enhanced word extraction
- Complete vocabulary mode in Word Index

### Version 0.1.0

- Initial conversion from the original Dfr-Browser.
- Complete functionality prototyped.

---

**Last Updated:** October 2025
