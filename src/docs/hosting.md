# Hosting

The application uses [page.js](https://visionmedia.github.io/page.js/) to handle page urls. All requests must be served to index.html to allow client-side routing. Additionally, the routing system assumes a server configured for HTML5 history routing.

WARNING:

But this whole thing is messed up because assets are being pulled from node_module, possibly at a level above the version being run. I need to produce a dist version that has the third-part modules in assets, not node_modules.

## Localhost with Python

The easiest way to handle this is to start a specially configured localhost with Python using the `server.py` script. Just run `python3 server.py` from the command line.

## Localhost with Node.js

TBD

## Hosting on a Remote Server

The following solutions were generated by Claude Sonnet 4.5 and have not been tested. They are provided here as a starting point.

### LAMP Stacks

Most hosting services provide LAMP stacks in which you can easily modify the routing configuration using an `.htaccess` file. Here's the equivalent configuration to the `server.py.` file:

````apache
# Enable rewrite engine
RewriteEngine On

# Set base directory (adjust if your app is in a subdirectory)
RewriteBase /

# Don't rewrite requests for actual files that exist
RewriteCond %{REQUEST_FILENAME} !-f

# Don't rewrite requests for actual directories that exist
RewriteCond %{REQUEST_FILENAME} !-d

# Don't rewrite requests for static file extensions
RewriteCond %{REQUEST_URI} !\.(js|css|png|jpg|jpeg|gif|svg|ico|json|txt|csv|gz|woff|woff2|ttf|eot|map)$ [NC]

# Rewrite everything else to index.html for client-side routing
RewriteRule ^.*$ index.html [L,QSA]
````

**What this does:**

1. **`RewriteEngine On`** - Enables URL rewriting
2. **`RewriteBase /`** - Sets the base path (change to `/myapp/` if in a subdirectory)
3. **`!-f` condition** - Skips rewrite if the file actually exists
4. **`!-d` condition** - Skips rewrite if the directory actually exists
5. **Static extensions check** - Prevents rewriting requests for CSS, JS, images, etc.
6. **Final rule** - Redirects everything else to `index.html` while preserving query strings (`QSA`)

**Additional recommendations:**

If you also want to add caching, compression, and security headers:

````apache
# Enable rewrite engine
RewriteEngine On
RewriteBase /

# SPA Routing
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteCond %{REQUEST_URI} !\.(js|css|png|jpg|jpeg|gif|svg|ico|json|txt|csv|gz|woff|woff2|ttf|eot|map)$ [NC]
RewriteRule ^.*$ index.html [L,QSA]

# Enable GZIP compression
<IfModule mod_deflate.c>
    AddOutputFilterByType DEFLATE text/html text/plain text/xml text/css text/javascript application/javascript application/json
</IfModule>

# Browser caching for static assets
<IfModule mod_expires.c>
    ExpiresActive On
    ExpiresByType text/css "access plus 1 month"
    ExpiresByType application/javascript "access plus 1 month"
    ExpiresByType image/png "access plus 1 year"
    ExpiresByType image/jpeg "access plus 1 year"
    ExpiresByType image/svg+xml "access plus 1 year"
    ExpiresByType application/json "access plus 0 seconds"
</IfModule>

# Security headers
<IfModule mod_headers.c>
    # Prevent clickjacking
    Header always set X-Frame-Options "SAMEORIGIN"

    # Prevent MIME sniffing
    Header always set X-Content-Type-Options "nosniff"

    # Enable XSS protection
    Header always set X-XSS-Protection "1; mode=block"

    # CORS (if needed for external APIs)
    # Header always set Access-Control-Allow-Origin "*"
</IfModule>

# UTF-8 encoding
AddDefaultCharset utf-8
````

**Testing:**

1. Place `.htaccess` in your web root (same directory as `index.html`)
2. Ensure Apache has `mod_rewrite` enabled: `sudo a2enmod rewrite`
3. Ensure your Apache config allows `.htaccess` overrides:

   ```apache
   <Directory /var/www/html>
       AllowOverride All
   </Directory>
   ```

4. Restart Apache: `sudo systemctl restart apache2`

This will work identically to the `server.py`, allowing page.js to handle all routing client-side while serving `index.html` for any non-file routes.

### Python Servers

#### Option 1: Gunicorn + Flask/FastAPI (Recommended for Production)

Create a simple WSGI application:

````python
from flask import Flask, send_from_directory
import os

app = Flask(__name__, static_folder='.')

@app.route('/', defaults={'path': ''})
@app.route('/<path:path>')
def serve(path):
    # Static file extensions to serve directly
    static_extensions = ['.js', '.css', '.png', '.jpg', '.jpeg', '.gif',
                         '.svg', '.ico', '.json', '.txt', '.csv', '.gz',
                         '.woff', '.woff2', '.ttf', '.eot', '.map']

    # If path has extension and file exists, serve it
    if any(path.endswith(ext) for ext in static_extensions):
        if os.path.exists(path):
            return send_from_directory('.', path)

    # Check if exact file exists
    if os.path.exists(path) and os.path.isfile(path):
        return send_from_directory('.', path)

    # Otherwise serve index.html for SPA routing
    return send_from_directory('.', 'index.html')

if __name__ == '__main__':
    app.run(host='0.0.0.0', port=8000)
````

**Install dependencies:**

```bash
pip install flask gunicorn
```

**Run with Gunicorn:**

```bash
gunicorn -w 4 -b 0.0.0.0:8000 app:app
```

**Create systemd service** (`/etc/systemd/system/dfr-browser.service`):

```ini
[Unit]
Description=DFR Browser SPA
After=network.target

[Service]
User=www-data
WorkingDirectory=/var/www/dfr-browser
Environment="PATH=/var/www/dfr-browser/venv/bin"
ExecStart=/var/www/dfr-browser/venv/bin/gunicorn -w 4 -b 0.0.0.0:8000 app:app

[Install]
WantedBy=multi-user.target
```

---

#### Option 2: Nginx + Python (Recommended for Performance)

Use Nginx as reverse proxy with your Python server running as a service.

**1. Create a production-ready Python server:**

````python
import http.server
import socketserver
import os
from urllib.parse import unquote
import signal
import sys

PORT = 8000

class SPAHandler(http.server.SimpleHTTPRequestHandler):
    def do_GET(self):
        path = unquote(self.path)

        if "?" in path:
            path = path.split("?")[0]
        if "#" in path:
            path = path.split("#")[0]

        file_path = os.path.join(os.getcwd(), path.lstrip("/"))

        if os.path.isdir(file_path) or not os.path.exists(file_path):
            if not any(path.endswith(ext) for ext in [
                ".js", ".css", ".png", ".jpg", ".jpeg", ".gif",
                ".svg", ".ico", ".json", ".txt", ".csv", ".gz",
                ".woff", ".woff2", ".ttf", ".eot", ".map"
            ]):
                self.path = "/index.html"

        return http.server.SimpleHTTPRequestHandler.do_GET(self)

    def end_headers(self):
        # Add CORS and caching headers
        self.send_header('Access-Control-Allow-Origin', '*')
        if self.path.endswith(('.js', '.css')):
            self.send_header('Cache-Control', 'max-age=2592000')  # 30 days
        elif self.path.endswith(('.png', '.jpg', '.jpeg', '.gif', '.svg')):
            self.send_header('Cache-Control', 'max-age=31536000')  # 1 year
        http.server.SimpleHTTPRequestHandler.end_headers(self)

def signal_handler(sig, frame):
    print('\nShutting down server...')
    sys.exit(0)

if __name__ == "__main__":
    signal.signal(signal.SIGINT, signal_handler)

    with socketserver.TCPServer(("0.0.0.0", PORT), SPAHandler) as httpd:
        print(f"Server running at http://0.0.0.0:{PORT}/")
        print("Press Ctrl+C to stop")
        httpd.serve_forever()
````

**2. Create systemd service** (`/etc/systemd/system/dfr-browser.service`):

```ini
[Unit]
Description=DFR Browser Python Server
After=network.target

[Service]
Type=simple
User=www-data
WorkingDirectory=/var/www/dfr-browser
ExecStart=/usr/bin/python3 /var/www/dfr-browser/server.py
Restart=always

[Install]
WantedBy=multi-user.target
```

**3. Configure Nginx** (`/etc/nginx/sites-available/dfr-browser`):

```nginx
server {
    listen 80;
    server_name yourdomain.com;

    location / {
        proxy_pass http://localhost:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Optional: serve static files directly from Nginx (better performance)
    location ~* \.(js|css|png|jpg|jpeg|gif|svg|ico|woff|woff2|ttf|eot)$ {
        root /var/www/dfr-browser;
        expires 30d;
        add_header Cache-Control "public, immutable";
    }
}
```

**Enable and start:**

```bash
sudo ln -s /etc/nginx/sites-available/dfr-browser /etc/nginx/sites-enabled/
sudo systemctl enable dfr-browser
sudo systemctl start dfr-browser
sudo systemctl reload nginx
```

---

#### Option 3: Docker (Easiest Deployment)

**Dockerfile:**

````dockerfile
FROM python:3.11-slim

WORKDIR /app

COPY . .

EXPOSE 8000

CMD ["python", "server.py"]
````

**docker-compose.yml:**

````yaml
version: '3.8'

services:
  dfr-browser:
    build: .
    ports:
      - "8000:8000"
    volumes:
      - ./data:/app/data
    restart: unless-stopped
````

**Deploy:**

```bash
docker-compose up -d
```

---

#### Option 4: Using uvicorn + FastAPI (Modern Alternative)

````python
from fastapi import FastAPI
from fastapi.responses import FileResponse
from fastapi.staticfiles import StaticFiles
import os

app = FastAPI()

# Serve static files
app.mount("/css", StaticFiles(directory="css"), name="css")
app.mount("/js", StaticFiles(directory="js"), name="js")
app.mount("/data", StaticFiles(directory="data"), name="data")
app.mount("/assets", StaticFiles(directory="assets"), name="assets")

@app.get("/{full_path:path}")
async def serve_spa(full_path: str):
    # Static extensions
    static_extensions = ['.js', '.css', '.png', '.jpg', '.jpeg', '.gif',
                         '.svg', '.ico', '.json', '.txt', '.csv', '.gz',
                         '.woff', '.woff2', '.ttf', '.eot', '.map']

    # Check if it's a static file request
    if any(full_path.endswith(ext) for ext in static_extensions):
        if os.path.exists(full_path):
            return FileResponse(full_path)

    # Serve index.html for SPA routes
    return FileResponse("index.html")
````

**Install and run:**

```bash
pip install fastapi uvicorn
uvicorn app:app --host 0.0.0.0 --port 8000 --workers 4
```

---

#### Recommended Setup: Nginx + Gunicorn + Flask

**Full production setup:**

1. **Install dependencies:**

```bash
sudo apt update
sudo apt install python3-pip nginx
pip install flask gunicorn
```

2. **Deploy files:**

```bash
sudo mkdir -p /var/www/dfr-browser
sudo cp -r * /var/www/dfr-browser/
sudo chown -R www-data:www-data /var/www/dfr-browser
```

3. **Create and enable systemd service** (see Option 1 above)

4. **Configure Nginx as reverse proxy** (see Option 2 above)

5. **Enable HTTPS with Let's Encrypt:**

```bash
sudo apt install certbot python3-certbot-nginx
sudo certbot --nginx -d yourdomain.com
```

This gives you a production-ready setup with:

- ✅ Process management (systemd)
- ✅ Reverse proxy (Nginx)
- ✅ SSL/TLS (Let's Encrypt)
- ✅ Static file caching
- ✅ Auto-restart on failure

