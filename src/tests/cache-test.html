<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cache Clearing Test</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 800px;
      margin: 50px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .test-section {
      background: white;
      padding: 20px;
      margin: 20px 0;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    button {
      background: #007bff;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      margin: 5px;
    }
    button:hover {
      background: #0056b3;
    }
    button.danger {
      background: #dc3545;
    }
    button.danger:hover {
      background: #c82333;
    }
    button.success {
      background: #28a745;
    }
    button.success:hover {
      background: #218838;
    }
    .output {
      background: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 4px;
      padding: 15px;
      margin-top: 15px;
      font-family: 'Courier New', monospace;
      white-space: pre-wrap;
      max-height: 400px;
      overflow-y: auto;
    }
    .status {
      padding: 10px;
      margin: 10px 0;
      border-radius: 4px;
    }
    .status.pass {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    .status.fail {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    .status.info {
      background: #d1ecf1;
      color: #0c5460;
      border: 1px solid #bee5eb;
    }
  </style>
</head>
<body>
  <h1>IndexedDB Cache Clearing Test</h1>

  <div class="test-section">
    <h2>Test Controls</h2>
    <button onclick="runFullTest()">Run Full Test Suite</button>
    <button onclick="checkCacheStats()">Check Cache Stats</button>
    <button class="success" onclick="populateTestData()">Populate Test Data</button>
    <button class="danger" onclick="clearAllCaches()">Clear All Caches</button>
    <button onclick="clearOutput()">Clear Output</button>
  </div>

  <div class="test-section">
    <h2>Individual Cache Tests</h2>
    <button onclick="testTopicKeysCache()">Test Topic Keys Cache</button>
    <button onclick="testDocTopicCache()">Test Doc-Topic Cache</button>
    <button onclick="testMetadataCache()">Test Metadata Cache</button>
    <button onclick="testBibliographyCache()">Test Bibliography Cache</button>
  </div>

  <div class="test-section">
    <h2>Test Output</h2>
    <div id="output" class="output">Waiting for test to run...</div>
  </div>

  <script type="module">
    import CacheManager from '../js/cache-manager.js';

    // Make CacheManager available globally for the test functions
    window.CacheManager = CacheManager;

    let testResults = [];

    function log(message, type = 'info') {
      const output = document.getElementById('output');
      const timestamp = new Date().toLocaleTimeString();
      const line = `[${timestamp}] ${message}\n`;
      output.textContent += line;
      output.scrollTop = output.scrollHeight;

      if (type === 'pass' || type === 'fail') {
        testResults.push({ message, type, timestamp });
      }
    }

    function addStatus(message, type = 'info') {
      const output = document.getElementById('output');
      const div = document.createElement('div');
      div.className = `status ${type}`;
      div.textContent = message;
      const tempDiv = document.createElement('div');
      tempDiv.appendChild(div);
      output.innerHTML += tempDiv.innerHTML + '\n';
      output.scrollTop = output.scrollHeight;
    }

    window.log = log;
    window.addStatus = addStatus;
    window.testResults = testResults;

    window.clearOutput = function() {
      document.getElementById('output').textContent = '';
      testResults = [];
      log('Output cleared');
    };

    window.checkCacheStats = async function() {
      log('Checking cache statistics...');
      try {
        const stats = await CacheManager.getStats();
        log('Cache Statistics:');
        log(JSON.stringify(stats, null, 2));

        const total = Object.values(stats).reduce((sum, count) => sum + count, 0);
        addStatus(`Total cached items: ${total}`, total > 0 ? 'info' : 'info');
      } catch (err) {
        log(`Error getting stats: ${err.message}`, 'fail');
        addStatus('Failed to get cache statistics', 'fail');
      }
    };

    window.populateTestData = async function() {
      log('Populating test data in all caches...');

      try {
        // Ensure CacheManager is initialized
        await CacheManager.init();

        // Test data for topic keys
        const testTopicKeys = [
          { alpha: [0.1], words: ['test', 'topic', 'one'], weights: [0.5, 0.3, 0.2] },
          { alpha: [0.2], words: ['test', 'topic', 'two'], weights: [0.6, 0.3, 0.1] }
        ];
        await CacheManager.set(CacheManager.stores.TOPIC_KEYS, 'test-topic-keys', testTopicKeys);
        log('✓ Added topic keys test data');

        // Test data for doc-topic
        const testDocTopic = [[0.5, 0.3], [0.2, 0.7]];
        await CacheManager.set(CacheManager.stores.DOC_TOPICS, 'test-doc-topic', testDocTopic);
        log('✓ Added doc-topic test data');

        // Test data for metadata
        const testMetadata = [
          { id: 'doc1', title: 'Test Document 1', author: 'Test Author' },
          { id: 'doc2', title: 'Test Document 2', author: 'Test Author' }
        ];
        await CacheManager.set(CacheManager.stores.METADATA, 'test-metadata', testMetadata);
        log('✓ Added metadata test data');

        // Test data for bibliography
        const testBibliography = [
          { id: 'doc1', 'formatted-citation': 'Test Citation 1' },
          { id: 'doc2', 'formatted-citation': 'Test Citation 2' }
        ];
        await CacheManager.set(CacheManager.stores.BIBLIOGRAPHY, 'test-bibliography', testBibliography);
        log('✓ Added bibliography test data');

        addStatus('Test data populated successfully', 'pass');
        await checkCacheStats();
      } catch (err) {
        log(`Error populating test data: ${err.message}`, 'fail');
        addStatus('Failed to populate test data', 'fail');
      }
    };

    window.clearAllCaches = async function() {
      log('Clearing all caches...');
      try {
        await CacheManager.clearAll();
        addStatus('All caches cleared successfully', 'pass');
        await checkCacheStats();
      } catch (err) {
        log(`Error clearing caches: ${err.message}`, 'fail');
        addStatus('Failed to clear caches', 'fail');
      }
    };

    window.testTopicKeysCache = async function() {
      log('\n=== Testing Topic Keys Cache ===');
      try {
        await CacheManager.init();

        // Add data
        const testData = [{ alpha: [0.1], words: ['test'], weights: [1.0] }];
        await CacheManager.set(CacheManager.stores.TOPIC_KEYS, 'test-key', testData);
        log('✓ Data added to cache');

        // Verify data exists
        const retrieved = await CacheManager.get(CacheManager.stores.TOPIC_KEYS, 'test-key');
        if (retrieved && JSON.stringify(retrieved.data) === JSON.stringify(testData)) {
          log('✓ Data retrieved successfully');
          addStatus('Topic Keys Cache: Working', 'pass');
        } else {
          log('✗ Retrieved data does not match', 'fail');
          addStatus('Topic Keys Cache: FAILED', 'fail');
          return false;
        }

        // Clear specific cache
        await CacheManager.clear(CacheManager.stores.TOPIC_KEYS);
        log('✓ Cache cleared');

        // Verify data is gone
        const afterClear = await CacheManager.get(CacheManager.stores.TOPIC_KEYS, 'test-key');
        if (!afterClear) {
          log('✓ Data successfully removed');
          addStatus('Topic Keys Clear: Working', 'pass');
          return true;
        } else {
          log('✗ Data still exists after clear!', 'fail');
          addStatus('Topic Keys Clear: FAILED', 'fail');
          return false;
        }
      } catch (err) {
        log(`Error: ${err.message}`, 'fail');
        addStatus('Topic Keys Test: ERROR', 'fail');
        return false;
      }
    };

    window.testDocTopicCache = async function() {
      log('\n=== Testing Doc-Topic Cache ===');
      try {
        await CacheManager.init();

        const testData = [[0.5, 0.5]];
        await CacheManager.set(CacheManager.stores.DOC_TOPICS, 'test-key', testData);
        log('✓ Data added');

        const retrieved = await CacheManager.get(CacheManager.stores.DOC_TOPICS, 'test-key');
        if (retrieved && JSON.stringify(retrieved.data) === JSON.stringify(testData)) {
          log('✓ Data retrieved');
          addStatus('Doc-Topic Cache: Working', 'pass');
        } else {
          addStatus('Doc-Topic Cache: FAILED', 'fail');
          return false;
        }

        await CacheManager.clear(CacheManager.stores.DOC_TOPICS);
        const afterClear = await CacheManager.get(CacheManager.stores.DOC_TOPICS, 'test-key');
        if (!afterClear) {
          log('✓ Clear verified');
          addStatus('Doc-Topic Clear: Working', 'pass');
          return true;
        } else {
          addStatus('Doc-Topic Clear: FAILED', 'fail');
          return false;
        }
      } catch (err) {
        log(`Error: ${err.message}`, 'fail');
        addStatus('Doc-Topic Test: ERROR', 'fail');
        return false;
      }
    };

    window.testMetadataCache = async function() {
      log('\n=== Testing Metadata Cache ===');
      try {
        await CacheManager.init();

        const testData = [{ id: 'test', title: 'Test' }];
        await CacheManager.set(CacheManager.stores.METADATA, 'test-key', testData);
        log('✓ Data added');

        const retrieved = await CacheManager.get(CacheManager.stores.METADATA, 'test-key');
        if (retrieved && JSON.stringify(retrieved.data) === JSON.stringify(testData)) {
          log('✓ Data retrieved');
          addStatus('Metadata Cache: Working', 'pass');
        } else {
          addStatus('Metadata Cache: FAILED', 'fail');
          return false;
        }

        await CacheManager.clear(CacheManager.stores.METADATA);
        const afterClear = await CacheManager.get(CacheManager.stores.METADATA, 'test-key');
        if (!afterClear) {
          log('✓ Clear verified');
          addStatus('Metadata Clear: Working', 'pass');
          return true;
        } else {
          addStatus('Metadata Clear: FAILED', 'fail');
          return false;
        }
      } catch (err) {
        log(`Error: ${err.message}`, 'fail');
        addStatus('Metadata Test: ERROR', 'fail');
        return false;
      }
    };

    window.testBibliographyCache = async function() {
      log('\n=== Testing Bibliography Cache ===');
      try {
        await CacheManager.init();

        const testData = [{ id: 'test', citation: 'Test Citation' }];
        await CacheManager.set(CacheManager.stores.BIBLIOGRAPHY, 'test-key', testData);
        log('✓ Data added');

        const retrieved = await CacheManager.get(CacheManager.stores.BIBLIOGRAPHY, 'test-key');
        if (retrieved && JSON.stringify(retrieved.data) === JSON.stringify(testData)) {
          log('✓ Data retrieved');
          addStatus('Bibliography Cache: Working', 'pass');
        } else {
          addStatus('Bibliography Cache: FAILED', 'fail');
          return false;
        }

        await CacheManager.clear(CacheManager.stores.BIBLIOGRAPHY);
        const afterClear = await CacheManager.get(CacheManager.stores.BIBLIOGRAPHY, 'test-key');
        if (!afterClear) {
          log('✓ Clear verified');
          addStatus('Bibliography Clear: Working', 'pass');
          return true;
        } else {
          addStatus('Bibliography Clear: FAILED', 'fail');
          return false;
        }
      } catch (err) {
        log(`Error: ${err.message}`, 'fail');
        addStatus('Bibliography Test: ERROR', 'fail');
        return false;
      }
    };

    window.runFullTest = async function() {
      clearOutput();
      log('='.repeat(50));
      log('STARTING FULL CACHE TEST SUITE');
      log('='.repeat(50));

      testResults = [];

      // Run all individual tests
      const tests = [
        { name: 'Topic Keys', fn: testTopicKeysCache },
        { name: 'Doc-Topic', fn: testDocTopicCache },
        { name: 'Metadata', fn: testMetadataCache },
        { name: 'Bibliography', fn: testBibliographyCache }
      ];

      for (const test of tests) {
        log(`\nRunning ${test.name} test...`);
        await test.fn();
      }

      // Test clearAll functionality
      log('\n=== Testing ClearAll Functionality ===');
      await populateTestData();

      const statsBeforeClear = await CacheManager.getStats();
      const totalBefore = Object.values(statsBeforeClear).reduce((sum, count) => sum + count, 0);
      log(`Items before clear: ${totalBefore}`);

      await CacheManager.clearAll();

      const statsAfterClear = await CacheManager.getStats();
      const totalAfter = Object.values(statsAfterClear).reduce((sum, count) => sum + count, 0);
      log(`Items after clear: ${totalAfter}`);

      if (totalAfter === 0) {
        log('✓ ClearAll successfully removed all items', 'pass');
        addStatus('ClearAll Function: Working', 'pass');
      } else {
        log(`✗ ClearAll failed - ${totalAfter} items remaining`, 'fail');
        addStatus('ClearAll Function: FAILED', 'fail');
      }

      // Summary
      log('\n' + '='.repeat(50));
      log('TEST SUITE COMPLETE');
      log('='.repeat(50));

      const passed = testResults.filter(r => r.type === 'pass').length;
      const failed = testResults.filter(r => r.type === 'fail').length;

      log(`\nResults: ${passed} passed, ${failed} failed`);

      if (failed === 0) {
        addStatus(`All tests passed! (${passed}/${passed})`, 'pass');
      } else {
        addStatus(`Some tests failed! (${passed} passed, ${failed} failed)`, 'fail');
      }
    };

    // Initialize on load
    log('Cache Test Suite Ready');
    log('Click "Run Full Test Suite" to begin testing');
  </script>
</body>
</html>
